stages: [build, deploy]

# 공통: Docker-in-Docker
image: docker:27
services:
  - name: docker:27-dind
    alias: docker
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1"
  # 기본 이미지 태그 (커밋 단위)
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

# 1) 이미지 빌드 + 푸시 (GitLab Registry)
build-image:
  stage: build
  script:
    # GitLab Registry 로그인
    - |
      echo "Login to GitLab Registry: $CI_REGISTRY"
      echo "CI_REGISTRY_USER: $CI_REGISTRY_USER"
      echo "CI_REGISTRY_PASSWORD: $CI_REGISTRY_PASSWORD"
      echo "CI_REGISTRY: $CI_REGISTRY"
      echo "IMAGE_TAG: $IMAGE_TAG"
      echo "CI_COMMIT_REF_SLUG: $CI_COMMIT_REF_SLUG"
      echo "CI_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA"
      echo "CI_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    
    # Docker 이미지 빌드 (최적화 옵션 포함)
    - |
      docker build \
      --build-arg BUILDKIT_INLINE_CACHE=1 \
      --cache-from "$CI_REGISTRY_IMAGE:latest" \
      -t "$CI_REGISTRY_IMAGE:$IMAGE_TAG" \
      -t "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG" \
      .
    
    # 이미지 푸시 (재시도 로직 포함)
    - |
      for i in {1..3}; do
        echo "Attempt $i/3: Pushing $CI_REGISTRY_IMAGE:$IMAGE_TAG"
        if docker push "$CI_REGISTRY_IMAGE:$IMAGE_TAG"; then
          echo "Successfully pushed $CI_REGISTRY_IMAGE:$IMAGE_TAG"
          break
        else
          echo "Push attempt $i failed"
          if [ $i -eq 3 ]; then
            echo "All push attempts failed"
            exit 1
          fi
          echo "Waiting 10 seconds before retry..."
          sleep 10
        fi
      done
    - |
      for i in {1..3}; do
        echo "Attempt $i/3: Pushing $CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG"
        if docker push "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG"; then
          echo "Successfully pushed $CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG"
          break
        else
          echo "Push attempt $i failed"
          if [ $i -eq 3 ]; then
            echo "All push attempts failed"
            exit 1
          fi
          echo "Waiting 10 seconds before retry..."
          sleep 10
        fi
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'  # 모든 브랜치에서 빌드

# 2) 배포: compose로 런타임 변수 주입 + 이미지 태그 override
deploy:
  stage: deploy
  needs: ["build-image"]
  services: []  # DinD 끔
  variables:
    DOCKER_HOST: "unix:///var/run/host_docker.sock"  # 별도로 정의한 host 소켓
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"

    # 런타임 env 파일 생성 (GitLab Variables 사용)
    - |
      echo "Creating .env.runtime file with GitLab Variables..."
      printf "NODE_ENV=production\nUSE_HTTPS=true\n" > .env.runtime
      
      # GitLab Variables에서 환경변수 주입
      echo "Checking for GitLab Variables..."
      if [ -n "$API_URL" ]; then
        echo "API_URL found, adding to .env.runtime"
        printf "API_URL=%s\n" "$API_URL" >> .env.runtime
      else
        echo "API_URL not set"
      fi
      
      if [ -n "$VITE_NAVER_CLIENT_ID" ]; then
        echo "VITE_NAVER_CLIENT_ID found, adding to .env.runtime"
        printf "VITE_NAVER_CLIENT_ID=%s\n" "$VITE_NAVER_CLIENT_ID" >> .env.runtime
      else
        echo "VITE_NAVER_CLIENT_ID not set"
      fi
      
      if [ -n "$VITE_NAVER_SECRET" ]; then
        echo "VITE_NAVER_SECRET found, adding to .env.runtime"
        printf "VITE_NAVER_SECRET=%s\n" "$VITE_NAVER_SECRET" >> .env.runtime
      else
        echo "VITE_NAVER_SECRET not set"
      fi
      
      if [ -n "$PORT" ]; then
        echo "PORT found, adding to .env.runtime"
        printf "PORT=%s\n" "$PORT" >> .env.runtime
      else
        echo "PORT not set, using default 3000"
      fi
      
      # 생성된 .env.runtime 파일 내용 확인 (민감한 정보는 마스킹)
      echo "Generated .env.runtime file:"
      cat .env.runtime | sed 's/=.*/=***MASKED***/'

    # 이미지 override + build 제거
    - |
      cat > compose.ci.yaml <<'YAML'
      services:
        app:
          build: null
          image: IMAGE_PLACEHOLDER
          env_file:
            - .env.runtime
          environment:
            NODE_ENV: "production"
            USE_HTTPS: "true"
            PORT: "3000"
          ports:
            - "3000:3000"
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
      YAML
    - sed -i "s|IMAGE_PLACEHOLDER|$CI_REGISTRY_IMAGE:$IMAGE_TAG|g" compose.ci.yaml

    - docker compose version

  script:
    - docker pull "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
    - docker compose -f docker-compose.yml -f compose.ci.yaml up -d
    - docker compose ps

  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "main"'
  #   - if: '$CI_COMMIT_BRANCH == "feat/express-initialize"'
